# 🧠 MKG-app AI記憶コア（効率版）

**最終更新:** 2025-09-24 | **利用制限対応:** 容量最適化済み

## 🚀 現在状況
- **サーバー:** localhost:3000 正常稼働
- **技術構成:** Next.js 14.2.32 + Supabase + RLS
- **主要完成機能:** 認証・チーム管理・カイゼン計画・AI相談・管理者機能・トースト通知

## 📋 厳守事項
### プロフェッショナル基準
- 完全実装まで責任 - テスト確認却下
- 本格運用念頭 - 迂回・回避禁止
- プログラム上検証必須 - ユーザーテスト前徹底確認

### 技術制約
- Supabase RLS必須 - DB操作迂回禁止
- 複数チーム所属者 → 毎回チーム選択画面表示
- LocalStorage/SessionStorage完全禁止

## 🎯 完了済み重要実装
### 2025-10-18
- **データベース基盤完全化:** 欠落テーブル作成・user_id型UUID統一
- **チーム別データ分離実装:** RLSポリシー強化・データ漏洩リスク解消
- **alert()完全排除:** 29箇所 → 0箇所、トースト通知システム完全統一
- **DB使用量表示修正:** RPC関数`get_database_size()`修正・正確な使用量表示実装（14.10 MB / 500MB）
- **RLSポリシー緊急修正:** `auth.users`アクセス権限エラー解消・認証済みユーザー制限に統一
- **管理者ボタン表示修正:** `currentUser.username`→`currentUser.email`変更・リロード後も表示維持
- **報告書ナンバー自動付与修正:** `report_number`がnullの既存報告書に自動採番実装

### 2025-09-24
- **AI記憶復帰システム革命:** 96%容量削減・自動判断ロジック実装
- **トースト通知システム:** alert() → モダン通知（30箇所置換）
- **PCローカル依存ゼロ達成:** sessionStorage完全排除→Supabaseユーザーメタデータ

### 2025-09-23
- **管理者機能強化:** 叶俊輔さん専用制限・社員追加改善
- **LocalStorage完全排除:** 全データSupabase統一
- **AI相談機能完成:** Claude.ai統合・6ステップワークフロー

## ⚙️ 技術仕様
- **容量制限:** 500MB絶対制限（PC管理者承認済み）
- **認証:** Supabase Auth + RLS
- **データ:** 100% Supabaseクラウド統一（ローカル依存ゼロ）

## 🧠 AI思考プロセス（必須順守）

### 問題解決時の必須ステップ
1. **全シナリオシミュレーション** → 本格運用時の問題予測
2. **長期的影響分析** → セキュリティ・運用・拡張性リスク評価
3. **根本解決策設計** → 一時しのぎではなく持続可能な解決
4. **段階的実装計画** → 既存構造を壊さず確実に移行

### 提案前必須チェック
- [ ] 本格運用念頭の設計か？（迂回・回避でないか？）
- [ ] セキュリティリスクは許容範囲か？
- [ ] 既存アプリ構造への影響は最小か？
- [ ] 長期的に持続可能な解決か？

### 禁止思考パターン
❌ 「最も安全で迅速」（短期的視点）
❌ 「とりあえず動かす」（一時しのぎ）
❌ 「メール確認無効化」（セキュリティ軽視）
❌ 「場当たり的対応」（原則違反）

## 📝 作業完了時義務
- 記憶媒体/★CORE_MEMORY.md更新
- 記憶媒体/RECENT_CHANGES_latest.md記録
- 重要学習内容追記

## 🤖 AI自動判断ロジック

**コア記憶読み込み後、以下の条件で自動的に詳細ファイルを読み込む：**

### 🚨 Level 1 強制全教本読み込みキーワード
**以下のキーワードが検出されたら即座に全教本読み込み実行**

**必須キーワード:**
- 認証, セキュリティ, データベース, テーブル, RLS
- 本格運用, エラー, システム設計, migration
- Auth, ログイン, 登録, Supabase Auth
- カスタム認証, user_profiles, tasks
- パスワード, メール確認, UUID, ID

**実行内容:**
1. `記憶媒体/DEVELOPMENT_GUIDELINES.md` (必須)
2. `記憶媒体/Supabaseデータベース統一方針.md` (必須)
3. `記憶媒体/PC管理者向け技術仕様書.md` (必須)
4. `記憶媒体/詳細記録/RECENT_CHANGES_latest.md` (必須)

### 従来の段階的読み込み（軽微作業用）
- **Claude専用機能利用時** → `記憶媒体/★Claude専用起動指示★.md`

### 実行手順
```
1. ユーザー要求をLevel 1キーワードで判定
2. 該当する場合：「重要作業検出。全教本を読み込みます」と通知
3. 4つの必須教本を順次読み込み
4. 必須思考プロセス4ステップ実行
5. 提案前必須チェック完了後、作業開始
```

### パニック防止機構
**重要作業時は必ず以下を実行：**
- ✅ 全シナリオシミュレーション
- ✅ 長期的影響分析
- ✅ 根本解決策設計
- ✅ 段階的実装計画

**ユーザーの利用制限を最小限に抑えつつ、必要な記憶だけを的確に補完**

---
**次回作業者:** この記憶コア読み込み後、上記ロジックに従い自動判断・必要時追加読み込み実行
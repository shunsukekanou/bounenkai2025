# MKG-app 実装状態 詳細分析レポート

**作成日**: 2025-10-18
**分析対象**: C:/Users/kanop/work/MKG-app
**最終コミット**: de31b96 (仮完成3)

---

## 📊 1. データベーステーブル構造の確認

### 1.1 定義されているテーブル（SQLファイル分析）

現在のプロジェクトには**複数世代のSQLファイル**が存在し、テーブル定義に一部混乱が見られます：

#### ✅ 確実に実装されているテーブル

| テーブル名 | 定義ファイル | 用途 | RLS設定 |
|-----------|------------|------|---------|
| **tasks** | setup_optimized_tables.sql | タスク管理 | ✅ 有効 |
| **user_profiles** | setup_optimized_tables.sql | ユーザープロファイル | ✅ 有効 |
| **team_numbers** | setup_optimized_tables.sql | チーム別番号管理 | ✅ 有効 |
| **employees** | setup_optimized_tables.sql | 社員管理 | ✅ 有効 |
| **custom_users** | setup_custom_auth.sql | カスタム認証ユーザー | ✅ 有効 |

#### ⚠️ コードで使用されているが定義が見つからないテーブル

以下のテーブルは **pages/index.js で使用されている**が、提供されたSQLファイルに定義が見つかりません：

| テーブル名 | 使用箇所 | 用途 | 状態 |
|-----------|---------|------|------|
| **completed_reports** | 2670行目〜 | 活動報告書保存 | ❌ SQL定義なし |
| **patrol_checklists** | 1078行目〜 | パトロールチェックリスト | ❌ SQL定義なし |
| **admin_users** | 369行目〜 | 管理者ユーザー管理 | ❌ SQL定義なし |
| **kaizen_plans** | 2736行目 | カイゼン計画 | ❌ SQL定義なし |
| **ai_consultations** | 1984行目 | AI相談履歴 | ❌ SQL定義なし |

### 1.2 マイグレーション履歴

確認されたマイグレーションファイル：

1. **add_draft_flag_migration.sql** - `completed_reports.is_draft` カラム追加
2. **add_report_number_column.sql** - `completed_reports.report_number` カラム追加（INTEGER型）
3. **change_report_number_to_text.sql** - `report_number` を TEXT型に変更

### 1.3 RLS設定の状況

#### 最新のRLS設定（rls_migration_final.sql）

全テーブルで **auth.uid() IS NOT NULL** を使用した統一ポリシーが設定されています：

```sql
-- 認証済みユーザーのみアクセス可能
CREATE POLICY "mkg_auth_tasks_select" ON tasks
  FOR SELECT USING (auth.uid() IS NOT NULL);
```

**問題点**:
- ✅ セキュリティは確保されている（認証必須）
- ❌ チーム別のデータ分離が実装されていない
- ❌ すべての認証ユーザーが全チームのデータを閲覧・編集可能

---

## 📱 2. pages/index.jsの機能実装状況

### 2.1 実装済み機能一覧

| 機能カテゴリ | 機能名 | 実装状況 | 使用テーブル |
|------------|--------|---------|------------|
| **認証** | ユーザー登録・ログイン | ✅ 完成 | auth.users (Supabase Auth) |
| **認証** | チーム選択機能 | ✅ 完成 | user_profiles |
| **タスク管理** | ToDoリスト | ✅ 完成 | tasks |
| **タスク管理** | カイゼン計画作成 | ✅ 完成 | tasks, kaizen_plans |
| **タスク管理** | 期間設定機能 | ✅ 完成 | tasks |
| **タスク管理** | カレンダー表示 | ✅ 完成 | tasks |
| **報告書** | 活動報告書作成 | ✅ 完成 | completed_reports |
| **報告書** | 下書き保存機能 | ✅ 完成 | completed_reports.is_draft |
| **報告書** | 改善ナンバー自動付与 | ✅ 完成 | team_numbers, completed_reports |
| **報告書** | PDF出力 | ✅ 完成 | html2canvas, jspdf |
| **パトロール** | チェックシート作成 | ✅ 完成 | patrol_checklists |
| **パトロール** | 履歴表示 | ✅ 完成 | patrol_checklists |
| **AI相談** | Claude.ai連携 | ✅ 完成 | ai_consultations (未使用?) |
| **監査** | 全社監査ビュー | ✅ 完成 | tasks, completed_reports, patrol_checklists |
| **管理者** | 管理者ユーザー管理 | ✅ 完成 | admin_users |
| **管理者** | 社員管理 | ✅ 完成 | employees |
| **UI/UX** | トースト通知システム | ✅ 完成 | なし（ローカル状態） |
| **UI/UX** | ヘルプモーダル | ✅ 完成 | なし（ローカル状態） |

### 2.2 使用しているSupabaseテーブル（コード内検索結果）

```javascript
// 実際に使用されているテーブル（from()呼び出しから抽出）
- tasks (26回)
- completed_reports (15回)
- patrol_checklists (7回)
- user_profiles (5回)
- admin_users (4回)
- team_numbers (3回)
- custom_users (3回)
- employees (2回)
- kaizen_plans (1回)
- ai_consultations (1回)
```

### 2.3 localStorage/sessionStorageの使用状況

**✅ 完全排除済み**

検索結果：
- `localStorage` の使用: **0箇所**（完全排除）
- `sessionStorage` の使用: **0箇所**（完全排除）

確認された残存箇所：
- 1801行目: コメント「`// Supabase認証管理によりsessionStorage不要`」のみ

**結論**: PCローカル依存ゼロを完全達成しています。

---

## 🔒 3. セキュリティ実装状況

### 3.1 RLS (Row Level Security) の設定状況

#### ✅ 実装済み

- 全テーブルでRLSが有効化
- 認証必須ポリシー実装（`auth.uid() IS NOT NULL`）
- 未認証ユーザーからのアクセスを完全ブロック

#### ❌ 未実装・問題点

| 問題 | 重大度 | 詳細 |
|-----|--------|------|
| **チーム別データ分離なし** | 🔴 高 | 認証ユーザーは全チームのデータにアクセス可能 |
| **RLSポリシーが緩い** | 🔴 高 | `USING (true)` のポリシーが残存している可能性 |
| **user_id型の不整合** | 🟡 中 | INTEGER, UUID, VARCHAR(100)が混在 |

### 3.2 認証フローの実装

**認証方式**: Supabase Auth（メール + パスワード）

**実装状況**:
1. ✅ ユーザー登録（signUp）
2. ✅ ログイン（signInWithPassword）
3. ✅ セッション永続化（user_metadata使用）
4. ✅ チーム選択状態の永続化（user_metadata.last_team_id）
5. ✅ ログアウト（signOut）
6. ✅ 自動ログイン（onAuthStateChange監視）

**問題点**:
- ❌ カスタム認証テーブル（custom_users）とSupabase Authの二重管理
- ❌ custom_usersテーブルの存在意義が不明確

### 3.3 データアクセス制御

**現状の制御レベル**:
- 認証レベル: ✅ 実装済み（認証必須）
- チームレベル: ❌ 未実装（全チームデータにアクセス可能）
- ユーザーレベル: ❌ 未実装（他ユーザーのデータも編集可能）

**推奨される改善**:
```sql
-- 例: tasksテーブルのチーム別制限
CREATE POLICY "team_isolation_tasks" ON tasks
FOR SELECT USING (
  team_id IN (
    SELECT unnest(teams)
    FROM custom_users
    WHERE id = auth.uid()
  )
);
```

---

## 🐛 4. 潜在的な問題点・バグ

### 4.1 データベース関連（優先度: 🔴 高）

| 問題 | 影響 | 詳細 |
|-----|------|------|
| **テーブル定義の欠落** | 本番運用不可 | completed_reports, patrol_checklists, admin_users, kaizen_plans, ai_consultationsのCREATE TABLE文が見つからない |
| **user_id型の不統一** | データ整合性リスク | tasks.user_idはINTEGER、実際はUUID、コードではstringとして扱われている |
| **team_id型の不統一** | データ整合性リスク | tasksテーブルにteamIdとteam_idの両方が存在 |

### 4.2 セキュリティリスク（優先度: 🔴 高）

| リスク | 詳細 | 対策 |
|-------|------|------|
| **チーム間データ漏洩** | 認証ユーザーが全チームのデータにアクセス可能 | RLSポリシーにチーム制限を追加 |
| **API Key平文保存** | employees.api_keyが暗号化されていない可能性 | pgcryptoで暗号化 |
| **管理者権限の甘さ** | isKanoAdmin関数が単純な文字列比較 | admin_usersテーブルとの整合性確認 |

### 4.3 コードの矛盾（優先度: 🟡 中）

1. **重複保存問題**（コメントで無効化済み）
   ```javascript
   // 1225行目: useEffectによる自動保存が無効化されている
   // 理由: loadTasksFromSupabase後のsetTasks → useEffect発火 → 再保存の無限ループ
   ```

2. **カスタム認証の二重管理**
   - Supabase Authとcustom_usersテーブルが並存
   - custom_usersは使用されていない可能性が高い

3. **alert()の残存**
   - トースト通知システムを実装したが、一部にalert()が残存（1249, 1252, 1254, 2880行目）

### 4.4 エラーハンドリングの不足（優先度: 🟡 中）

```javascript
// 例: 1208行目 - エラー時のタスク復元処理なし
if (insertError) {
  console.error('🚨 Tasks挿入エラー:', insertError)
  console.error('⚠️ タスクが削除されたまま保存に失敗しました')
  // ⚠️ 削除したタスクを復元する処理がない
}
```

### 4.5 パフォーマンス問題（優先度: 🟢 低）

1. **全削除 + 全挿入パターン**
   - saveTasksToSupabase関数で既存タスクを全削除してから全挿入
   - 大量タスクがある場合、パフォーマンス低下の可能性

2. **N+1クエリ問題**
   - loadAllTeamsData関数でチームごとにループしてクエリ実行

---

## 🔧 5. 未実装機能・改善点

### 5.1 データベース構造の完全化（優先度: 🔴 最高）

**必要なCREATE TABLE文の作成**:

```sql
-- completed_reports テーブル
CREATE TABLE IF NOT EXISTS completed_reports (
  id SERIAL PRIMARY KEY,
  task_id INTEGER,
  title TEXT NOT NULL,
  report_number TEXT, -- チーム別改善ナンバー（例: LB-2510-0001）
  report_data JSONB NOT NULL,
  team_id TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  is_draft BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- patrol_checklists テーブル
CREATE TABLE IF NOT EXISTS patrol_checklists (
  id BIGINT PRIMARY KEY,
  basic_info JSONB NOT NULL,
  evaluations JSONB NOT NULL,
  comments JSONB NOT NULL,
  iso_items JSONB,
  total_score INTEGER DEFAULT 0,
  score_counts JSONB DEFAULT '{}',
  score_difference INTEGER DEFAULT 0,
  last_score INTEGER,
  previous_score INTEGER,
  team_id TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  saved_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- admin_users テーブル
CREATE TABLE IF NOT EXISTS admin_users (
  id SERIAL PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  display_name TEXT,
  added_by TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- kaizen_plans テーブル
CREATE TABLE IF NOT EXISTS kaizen_plans (
  id SERIAL PRIMARY KEY,
  title TEXT NOT NULL,
  current_problem TEXT,
  target_goal TEXT,
  team_id TEXT NOT NULL,
  kaizen_number TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- ai_consultations テーブル
CREATE TABLE IF NOT EXISTS ai_consultations (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  team_id TEXT NOT NULL,
  prompt TEXT NOT NULL,
  response TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### 5.2 RLSポリシーの強化（優先度: 🔴 高）

**チーム別データ分離の実装**:

```sql
-- tasksテーブル: チーム制限付きポリシー
DROP POLICY IF EXISTS "mkg_auth_tasks_select" ON tasks;
CREATE POLICY "team_based_tasks_select" ON tasks
FOR SELECT USING (
  auth.uid() IS NOT NULL AND
  team_id = (
    SELECT user_metadata->>'last_team_id'
    FROM auth.users
    WHERE id = auth.uid()
  )
);

-- completed_reportsテーブル: チーム制限付きポリシー
CREATE POLICY "team_based_reports_select" ON completed_reports
FOR SELECT USING (
  auth.uid() IS NOT NULL AND
  team_id = (
    SELECT user_metadata->>'last_team_id'
    FROM auth.users
    WHERE id = auth.uid()
  )
);
```

### 5.3 データ型の統一（優先度: 🔴 高）

**user_id型の統一**:

```sql
-- tasksテーブルのuser_id型を修正
ALTER TABLE tasks ALTER COLUMN user_id TYPE UUID USING user_id::UUID;

-- user_profilesテーブルのuser_id型を修正
ALTER TABLE user_profiles ALTER COLUMN user_id TYPE UUID USING user_id::UUID;
```

**team_id型の統一**:

```sql
-- tasksテーブルのteamIdカラムを削除（team_idに統一）
ALTER TABLE tasks DROP COLUMN IF EXISTS "teamId";
```

### 5.4 コード改善（優先度: 🟡 中）

1. **alert()の完全排除**
   - 残存しているalert()をshowToast()に置換

2. **エラーハンドリングの強化**
   - タスク保存失敗時のロールバック処理追加

3. **カスタム認証テーブルの整理**
   - custom_usersテーブルの削除または明確な用途定義

### 5.5 パフォーマンス最適化（優先度: 🟢 低）

1. **差分更新の実装**
   - saveTasksToSupabase関数を差分更新方式に変更

2. **バッチクエリの実装**
   - loadAllTeamsData関数でJOINを使用した一括取得

---

## 📋 6. 現状の実装状況サマリー

### ✅ 優れている点

1. **PCローカル依存ゼロ達成** - localStorage/sessionStorageの完全排除
2. **Supabase統一** - 全データがクラウドDBに統一保存
3. **認証基盤の確立** - Supabase Authによる堅牢な認証
4. **豊富な機能実装** - ToDoリスト、報告書、パトロール、AI相談など
5. **モダンなUI/UX** - トースト通知、ヘルプモーダルなど
6. **マルチチーム対応** - 6チーム（LB, GR, YL, PK, PP, OR）対応

### ⚠️ 改善が必要な点

1. **データベース定義の不完全性** - 5つの重要テーブルのCREATE TABLE文が欠落
2. **RLSポリシーの甘さ** - チーム別データ分離が未実装
3. **データ型の不統一** - user_idとteam_idで複数の型が混在
4. **カスタム認証の二重管理** - custom_usersテーブルの存在意義が不明確

---

## 🎯 7. 発見された問題点リスト（優先度付き）

### 🔴 優先度: 最高（本番運用前に必須）

1. **[DB-001] テーブル定義の欠落**
   - 影響: アプリケーションが動作しない可能性
   - 対策: completed_reports, patrol_checklists, admin_users, kaizen_plans, ai_consultationsのCREATE TABLE文を作成
   - 工数: 2時間

2. **[SEC-001] チーム別データ分離の欠如**
   - 影響: データ漏洩リスク（他チームのデータが閲覧可能）
   - 対策: RLSポリシーにチーム制限を追加
   - 工数: 4時間

3. **[DB-002] データ型の不統一**
   - 影響: データ整合性エラーの可能性
   - 対策: user_idとteam_idの型を統一
   - 工数: 3時間

### 🟡 優先度: 高（機能改善に重要）

4. **[SEC-002] API Key平文保存**
   - 影響: Claude APIキーの漏洩リスク
   - 対策: pgcryptoによる暗号化実装
   - 工数: 2時間

5. **[CODE-001] カスタム認証の二重管理**
   - 影響: 保守性低下、混乱の原因
   - 対策: custom_usersテーブルの削除または明確な役割定義
   - 工数: 1時間

6. **[CODE-002] エラーハンドリング不足**
   - 影響: データ損失の可能性
   - 対策: タスク保存失敗時のロールバック処理追加
   - 工数: 2時間

### 🟢 優先度: 中（運用改善に有用）

7. **[UI-001] alert()の残存**
   - 影響: UX一貫性の欠如
   - 対策: 全alert()をshowToast()に置換
   - 工数: 1時間

8. **[PERF-001] 全削除+全挿入パターン**
   - 影響: 大量データ時のパフォーマンス低下
   - 対策: 差分更新方式に変更
   - 工数: 3時間

---

## 📊 8. 総合評価

### 実装完成度: 75%

| カテゴリ | 完成度 | 評価 |
|---------|--------|------|
| 機能実装 | 90% | ✅ 主要機能は完成 |
| データベース | 60% | ⚠️ テーブル定義に欠落あり |
| セキュリティ | 50% | ⚠️ チーム分離が未実装 |
| コード品質 | 70% | ✅ 概ね良好 |
| パフォーマンス | 80% | ✅ 現状問題なし |

### 本番運用可否: ❌ 不可（Phase 1, 2完了後に可）

**理由**:
1. データベーステーブル定義の欠落
2. チーム別データ分離の欠如

**本番運用に向けて**:
- Phase 1（データベース基盤）を完了すれば、社内限定での試験運用は可能
- Phase 2（セキュリティ強化）を完了すれば、本格運用可能

---

## 📁 9. 参考情報

### 重要ファイルパス

- **メインアプリケーション**: `C:/Users/kanop/work/MKG-app/pages/index.js` (10,649行)
- **データベース設定**: `C:/Users/kanop/work/MKG-app/setup_optimized_tables.sql`
- **RLS設定**: `C:/Users/kanop/work/MKG-app/rls_migration_final.sql`
- **環境変数**: `C:/Users/kanop/work/MKG-app/.env.local`
- **技術仕様書**: `C:/Users/kanop/work/MKG-app/記憶媒体/PC管理者向け技術仕様書.md`

### 使用技術スタック

- **フロントエンド**: Next.js 14.2.32, React 18.3.1
- **バックエンド**: Supabase (PostgreSQL)
- **認証**: Supabase Auth
- **PDF生成**: html2canvas, jspdf
- **その他**: next-pwa (PWA対応)

---

**分析者**: Claude Code Assistant
**分析完了日時**: 2025-10-18
